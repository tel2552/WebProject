<!-- templates/navbar.html -->
<style>
    .navbar {
        width: 250px;
        background-color: #333;
        color: white;
        height: 100vh;
        padding: 20px;
        box-sizing: border-box;
    }

    .navbar a {
        color: white;
        text-decoration: none;
        display: block;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .navbar a:hover {
        background-color: #575757;
    }
    .hidden {
        display: none;
    }
</style>
<div class="navbar">
    <a href="/admin_complaints">คำร้องใหม่</a>
    <a href="/reports">คำร้องของหน่วยงาน</a>
    <a href="/forwardeds">อนุมัติคำร้อง</a>
    <a href="/admin_download">รายงานสรุป</a>
    <a href="/cancelled_complaints">คำร้องที่ยกเลิก</a>
    <a href="/admin_control" id="admin-control-link" class="hidden">จัดการข้อมูล</a>
    <a href="#" onclick="logout()">ออกจากระบบ</a>
</div>
<script>
    async function logout() {
        try {
            // ลบ Token จาก localStorage
            localStorage.removeItem("access_token");

            // ส่งคำขอไปยังเซิร์ฟเวอร์เพื่อลบ Cookie (ถ้ามี)
            const response = await fetch("/logout", {
                method: "GET"
            });

            if (response.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'ออกจากระบบเรียบร้อยแล้ว',
                    showConfirmButton: false,
                    timer: 1500
                }).then(()=>{
                    window.location.href = "/";
                    checkUserRole(); // Call checkUserRole after logout
                })

            } else {
                const error = await response.json();
                Swal.fire({
                    icon: 'error',
                    title: `Error: ${error.detail}`,
                    showConfirmButton: true,
                })
            }
        } catch (error) {
            console.error("Error during logout:", error);
            Swal.fire({
                    icon: 'error',
                    title: "Failed to logout",
                    showConfirmButton: true,
                })
        }
    }

    async function checkUserRole() {
        console.log("checkUserRole() called");
        try {
            const token = localStorage.getItem('access_token');
            console.log("Token:", token);
            if (!token) {
                console.log('No access token found.');
                document.getElementById('admin-control-link').classList.add('hidden');
                return;
            }

            const response = await fetch('/admin/get-userrole', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const userRole = data.role;
                console.log("User Role:", userRole);
                const adminControlLink = document.getElementById('admin-control-link');

                if (userRole === 'alladmin') {
                    console.log("Showing admin control link");
                    adminControlLink.classList.remove('hidden');
                } else {
                    console.log("Hiding admin control link");
                    adminControlLink.classList.add('hidden');
                }
            } else {
                console.error('Failed to fetch user role:', response.statusText);
                document.getElementById('admin-control-link').classList.add('hidden');
            }
        } catch (error) {
            console.error('Error fetching user role:', error);
            document.getElementById('admin-control-link').classList.add('hidden');
        }
    }

    // Call checkUserRole when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded event fired");
        checkUserRole();
    });
</script>
